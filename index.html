<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­æœåŠ¡å¹³å° - ç®¡ç†å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            background-color: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4da6ff;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: #f9f9f9;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4da6ff;
            background-color: white;
        }
        
        .captcha-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .captcha-input {
            flex: 1;
        }
        
        .captcha-display {
            background: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            letter-spacing: 2px;
            user-select: none;
            cursor: pointer;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }
        
        .captcha-display span {
            position: relative;
            z-index: 2;
        }
        
        .captcha-display::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
            z-index: 1;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4da6ff, #3399ff);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, #3d8cd9, #2a7acc);
        }
        
        .login-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #ff4757;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* ç®¡ç†ç•Œé¢æ ·å¼ */
        .admin-content {
            display: none;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4da6ff, #3399ff);
            color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .card h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4da6ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-btn {
            flex: 1;
            padding: 12px;
            background-color: #4da6ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .admin-btn:hover {
            background-color: #3d8cd9;
        }
        
        .admin-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .danger-btn {
            background-color: #ff4757;
        }
        
        .danger-btn:hover {
            background-color: #ff3742;
        }
        
        .order-list {
            margin-top: 15px;
        }
        
        .order-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4da6ff;
        }
        
        .order-item.errand {
            border-left-color: #07c160;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-weight: bold;
            color: #4da6ff;
        }
        
        .order-type {
            display: inline-block;
            padding: 2px 8px;
            background-color: #f0f8ff;
            color: #4da6ff;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .order-type.errand {
            background-color: #e8f7ef;
            color: #07c160;
        }
        
        .order-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-taken {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .order-detail {
            margin-bottom: 5px;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-complete {
            background-color: #28a745;
            color: white;
        }
        
        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .user-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: white;
            padding: 8px 16px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .admin-management {
            display: none;
        }
        
        .admin-list {
            margin-top: 15px;
        }
        
        .admin-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-info {
            flex: 1;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
        }
        
        .admin-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .form-actions {
            grid-column: span 2;
            display: flex;
            gap: 10px;
        }
        
        .warning-text {
            color: #ff4757;
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background-color: #fff5f5;
            border-radius: 6px;
            border-left: 4px solid #ff4757;
        }
        
        .success-text {
            color: #28a745;
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background-color: #f0fff4;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .order-details {
                grid-template-columns: 1fr;
            }
            
            .admin-form {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="login-page">
        <div class="login-header">
            <h1>æ ¡å›­æœåŠ¡å¹³å°</h1>
            <p>ç®¡ç†å¹³å°ç™»å½•</p>
        </div>
        
        <div class="form-group">
            <label for="admin-username">ç”¨æˆ·å</label>
            <input type="text" id="admin-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>
        
        <div class="form-group">
            <label for="admin-password">å¯†ç </label>
            <input type="password" id="admin-password" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>
        
        <div class="form-group">
            <label for="captcha">éªŒè¯ç </label>
            <div class="captcha-container">
                <input type="text" id="captcha" class="captcha-input" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="4">
                <div id="captcha-display" class="captcha-display">
                    <span id="captcha-text"></span>
                </div>
            </div>
        </div>
        
        <button class="login-btn" id="login-btn">ç™»å½•</button>
        <div class="error-message" id="login-error">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
        
        <!-- é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯ -->
        <div class="warning-text" style="margin-top: 20px; text-align: left;">
            <strong>é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼š</strong><br>
            - æ€»ç®¡ç†å‘˜: superadmin / superadmin123<br>
            - æ™®é€šç®¡ç†å‘˜: admin / admin123
        </div>
    </div>
    
    <!-- ç®¡ç†ç•Œé¢ -->
    <div class="container admin-content" id="admin-content">
        <div class="user-info" id="user-info">
            <i class="fas fa-user"></i> <span id="current-user">ç®¡ç†å‘˜</span>
        </div>
        <button class="logout-btn" id="logout-btn">é€€å‡ºç™»å½•</button>
        
        <header>
            <h1>æ ¡å›­æœåŠ¡å¹³å° - ç®¡ç†å¹³å°</h1>
            <p class="subtitle">è®¢å•ç®¡ç†ä¸æ•°æ®ç»´æŠ¤</p>
        </header>
        
        <!-- æ•°æ®ç»Ÿè®¡éƒ¨åˆ† -->
        <div class="card">
            <h2>è®¢å•ç»Ÿè®¡</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-orders">0</div>
                    <div class="stat-label">æ€»è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pending-orders">0</div>
                    <div class="stat-label">å¾…å¤„ç†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="taken-orders">0</div>
                    <div class="stat-label">å·²æ¥å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-orders">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <button class="admin-btn" id="refresh-orders">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°è®¢å•
                </button>
                <button class="admin-btn" id="clear-completed">
                    <i class="fas fa-trash"></i> æ¸…é™¤å·²å®Œæˆ
                </button>
            </div>
            
            <div class="order-list" id="admin-orders-list">
                <!-- æ‰€æœ‰è®¢å•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- æ•°æ®ç®¡ç†éƒ¨åˆ† -->
        <div class="card">
            <h2>æ•°æ®ç®¡ç†</h2>
            
            <div class="warning-text">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>è­¦å‘Šï¼š</strong>ä»¥ä¸‹æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼
            </div>
            
            <div class="admin-controls">
                <button class="admin-btn danger-btn" id="clear-all-data">
                    <i class="fas fa-trash-alt"></i> æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®
                </button>
                <button class="admin-btn danger-btn" id="clear-chat-data">
                    <i class="fas fa-comments"></i> æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•
                </button>
            </div>
            
            <div class="admin-controls">
                <button class="admin-btn" id="export-data">
                    <i class="fas fa-download"></i> å¯¼å‡ºæ•°æ®å¤‡ä»½
                </button>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜ç®¡ç†éƒ¨åˆ† -->
        <div class="card admin-management" id="admin-management">
            <h2>ç®¡ç†å‘˜ç®¡ç†</h2>
            
            <div class="admin-controls">
                <button class="admin-btn" id="add-admin-btn">
                    <i class="fas fa-plus"></i> æ·»åŠ ç®¡ç†å‘˜
                </button>
                <button class="admin-btn danger-btn" id="reset-admin-btn">
                    <i class="fas fa-redo"></i> é‡ç½®ç®¡ç†å‘˜è´¦æˆ·
                </button>
            </div>
            
            <div class="warning-text" id="reset-warning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>é‡ç½®ç®¡ç†å‘˜è´¦æˆ·ï¼š</strong>æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰ç®¡ç†å‘˜è´¦æˆ·ï¼Œåªä¿ç•™é»˜è®¤è´¦æˆ·ï¼
            </div>
            
            <div class="success-text" id="reset-success" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <strong>é‡ç½®æˆåŠŸï¼š</strong>ç®¡ç†å‘˜è´¦æˆ·å·²æ¢å¤ä¸ºé»˜è®¤è®¾ç½®ï¼
            </div>
            
            <div class="admin-form" id="admin-form" style="display: none;">
                <div class="form-group">
                    <label for="new-username">ç”¨æˆ·å</label>
                    <input type="text" id="new-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="new-password">å¯†ç </label>
                    <input type="password" id="new-password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group">
                    <label for="confirm-password">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group">
                    <label for="admin-role">è§’è‰²</label>
                    <select id="admin-role">
                        <option value="admin">æ™®é€šç®¡ç†å‘˜</option>
                        <option value="super_admin">æ€»ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="admin-btn" id="save-admin">ä¿å­˜</button>
                    <button class="admin-btn" id="cancel-admin" style="background-color: #6c757d;">å–æ¶ˆ</button>
                </div>
            </div>
            
            <div class="admin-list" id="admin-list">
                <!-- ç®¡ç†å‘˜åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://mdkvoofsjmwxwsfoudbz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ka3Zvb2Zzam13eHdzZm91ZGJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODE2NTgsImV4cCI6MjA3NjQ1NzY1OH0.KXwS4CWYM5RIJ9RzQAVwAn9f1qvDBHykbil0CVykFP8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
        const DEFAULT_ADMIN_CREDENTIALS = {
            // æ€»ç®¡ç†å‘˜
            'superadmin': {
                password: 'superadmin123',
                role: 'super_admin',
                name: 'æ€»ç®¡ç†å‘˜'
            },
            // æ™®é€šç®¡ç†å‘˜
            'admin': {
                password: 'admin123',
                role: 'admin',
                name: 'ç®¡ç†å‘˜'
            }
        };
        
        // ç®¡ç†å‘˜è´¦æˆ·å­˜å‚¨é”®å
        const ADMIN_STORAGE_KEY = 'campus_admin_credentials';
        
        // è·å–ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯
        function getAdminCredentials() {
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–ç®¡ç†å‘˜è´¦æˆ·
            const storedAdmins = localStorage.getItem(ADMIN_STORAGE_KEY);
            
            if (storedAdmins) {
                try {
                    return JSON.parse(storedAdmins);
                } catch (error) {
                    console.error('è§£æå­˜å‚¨çš„ç®¡ç†å‘˜æ•°æ®å¤±è´¥:', error);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è´¦æˆ·å¹¶ä¿å­˜
                    saveAdminCredentials(DEFAULT_ADMIN_CREDENTIALS);
                    return DEFAULT_ADMIN_CREDENTIALS;
                }
            } else {
                // å¦‚æœæ²¡æœ‰å­˜å‚¨çš„ç®¡ç†å‘˜è´¦æˆ·ï¼Œä½¿ç”¨é»˜è®¤è´¦æˆ·å¹¶ä¿å­˜
                saveAdminCredentials(DEFAULT_ADMIN_CREDENTIALS);
                return DEFAULT_ADMIN_CREDENTIALS;
            }
        }
        
        // ä¿å­˜ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯
        function saveAdminCredentials(credentials) {
            localStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify(credentials));
        }
        
        // é‡ç½®ç®¡ç†å‘˜è´¦æˆ·ä¸ºé»˜è®¤è®¾ç½®
        function resetAdminCredentials() {
            saveAdminCredentials(DEFAULT_ADMIN_CREDENTIALS);
            return DEFAULT_ADMIN_CREDENTIALS;
        }
        
        // å½“å‰ä½¿ç”¨çš„ç®¡ç†å‘˜è´¦æˆ·
        let ADMIN_CREDENTIALS = getAdminCredentials();
        
        // å®‰å…¨ç›¸å…³å˜é‡
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 5;
        let captchaCode = '';
        
        // ç”Ÿæˆ4ä½éšæœºéªŒè¯ç ï¼ˆä¸­è‹±æ–‡æ··åˆï¼‰
        function generateCaptcha() {
            // ä¸­æ–‡å­—ç¬¦é›†
            const chineseChars = 'çš„ä¸€æ˜¯åœ¨ä¸äº†æœ‰å’Œäººè¿™ä¸­å¤§ä¸ºä¸Šä¸ªå›½æˆ‘ä»¥è¦ä»–æ—¶æ¥ç”¨ä»¬ç”Ÿåˆ°ä½œåœ°äºå‡ºå°±åˆ†å¯¹æˆä¼šå¯ä¸»å‘å¹´åŠ¨åŒå·¥ä¹Ÿèƒ½ä¸‹è¿‡å­è¯´äº§ç§é¢è€Œæ–¹åå¤šå®šè¡Œå­¦æ³•æ‰€æ°‘å¾—ç»åä¸‰ä¹‹è¿›ç€ç­‰éƒ¨åº¦å®¶ç”µåŠ›é‡Œå¦‚æ°´åŒ–é«˜è‡ªäºŒç†èµ·å°ç‰©ç°å®åŠ é‡éƒ½ä¸¤ä½“åˆ¶æœºå½“ä½¿ç‚¹ä»ä¸šæœ¬å»æŠŠæ€§å¥½åº”å¼€å®ƒåˆè¿˜å› ç”±å…¶äº›ç„¶å‰å¤–å¤©æ”¿å››æ—¥é‚£ç¤¾ä¹‰äº‹å¹³å½¢ç›¸å…¨è¡¨é—´æ ·ä¸å…³å„é‡æ–°çº¿å†…æ•°æ­£å¿ƒåä½ æ˜çœ‹åŸåˆä¹ˆååˆ©';
            
            // è‹±æ–‡å­—ç¬¦é›†
            const englishChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            
            // æ··åˆå­—ç¬¦é›†
            const mixedChars = chineseChars + englishChars;
            
            // ç”Ÿæˆ4ä½éªŒè¯ç 
            let captcha = '';
            for (let i = 0; i < 4; i++) {
                const randomIndex = Math.floor(Math.random() * mixedChars.length);
                captcha += mixedChars[randomIndex];
            }
            
            captchaCode = captcha;
            
            // æ˜¾ç¤ºéªŒè¯ç ï¼Œå¹¶æ·»åŠ å˜å½¢æ•ˆæœ
            const captchaText = document.getElementById('captcha-text');
            captchaText.innerHTML = '';
            
            for (let i = 0; i < captcha.length; i++) {
                const charSpan = document.createElement('span');
                charSpan.textContent = captcha[i];
                
                // éšæœºæ—‹è½¬è§’åº¦
                const rotation = Math.floor(Math.random() * 30) - 15;
                charSpan.style.transform = `rotate(${rotation}deg)`;
                
                // éšæœºå­—ä½“å¤§å°
                const fontSize = 18 + Math.floor(Math.random() * 8);
                charSpan.style.fontSize = `${fontSize}px`;
                
                // éšæœºé¢œè‰²
                const colors = ['#4da6ff', '#3399ff', '#ff4757', '#2ed573', '#ffa502'];
                const colorIndex = Math.floor(Math.random() * colors.length);
                charSpan.style.color = colors[colorIndex];
                
                captchaText.appendChild(charSpan);
            }
            
            // æ·»åŠ èƒŒæ™¯å¹²æ‰°çº¿
            const captchaDisplay = document.getElementById('captcha-display');
            captchaDisplay.style.backgroundImage = generateNoiseLines();
        }
        
        // ç”ŸæˆèƒŒæ™¯å¹²æ‰°çº¿ - ä¿®å¤ç‰ˆæœ¬
        function generateNoiseLines() {
            const lineCount = 5;
            let lines = [];
            
            for (let i = 0; i < lineCount; i++) {
                const startX = Math.random() * 100;
                const startY = Math.random() * 100;
                const endX = Math.random() * 100;
                const endY = Math.random() * 100;
                const color = `rgba(${Math.floor(Math.random() * 100)}, ${Math.floor(Math.random() * 100)}, ${Math.floor(Math.random() * 100)}, 0.3)`;
                
                lines.push(`linear-gradient(${Math.random() * 360}deg, transparent ${startX}%, ${color} ${startY}%, transparent ${endX}%)`);
            }
            
            return lines.join(', ');
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const currentUser = localStorage.getItem('currentUser');
            
            if (isLoggedIn && currentUser && ADMIN_CREDENTIALS[currentUser]) {
                showAdminContent(currentUser);
            } else {
                // æ¸…é™¤æ— æ•ˆçš„ç™»å½•çŠ¶æ€
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('currentUser');
                showLoginPage();
            }
        }
        
        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
            generateCaptcha();
            
            // é‡ç½®è¡¨å•
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('captcha').value = '';
        }
        
        // æ˜¾ç¤ºç®¡ç†å†…å®¹
        function showAdminContent(username) {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            if (!ADMIN_CREDENTIALS[username]) {
                console.error('ç”¨æˆ·ä¸å­˜åœ¨:', username);
                logout();
                return;
            }
            
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            
            const userInfo = ADMIN_CREDENTIALS[username];
            document.getElementById('current-user').textContent = userInfo.name;
            
            // å¦‚æœæ˜¯æ€»ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†å‘˜ç®¡ç†åŠŸèƒ½
            if (userInfo.role === 'super_admin') {
                document.getElementById('admin-management').style.display = 'block';
                renderAdminList();
            } else {
                document.getElementById('admin-management').style.display = 'none';
            }
            
            renderAdminOrders();
        }
        
        // ç™»å½•éªŒè¯
        function login() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const captcha = document.getElementById('captcha').value;
            const errorElement = document.getElementById('login-error');
            
            // æ£€æŸ¥éªŒè¯ç 
            if (captcha !== captchaCode) {
                errorElement.textContent = 'éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥';
                errorElement.style.display = 'block';
                generateCaptcha();
                return;
            }
            
            // æ£€æŸ¥ç™»å½•å°è¯•æ¬¡æ•°
            if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                errorElement.textContent = 'ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•';
                errorElement.style.display = 'block';
                document.getElementById('login-btn').disabled = true;
                setTimeout(() => {
                    document.getElementById('login-btn').disabled = false;
                    loginAttempts = 0;
                }, 30000); // 30ç§’åé‡ç½®
                return;
            }
            
            // éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
            if (ADMIN_CREDENTIALS[username] && ADMIN_CREDENTIALS[username].password === password) {
                // ç™»å½•æˆåŠŸ
                localStorage.setItem('adminLoggedIn', 'true');
                localStorage.setItem('currentUser', username);
                loginAttempts = 0;
                showAdminContent(username);
                
                // è®°å½•ç™»å½•æ—¥å¿—
                logSecurityEvent('login_success', username);
            } else {
                // ç™»å½•å¤±è´¥
                loginAttempts++;
                errorElement.textContent = `ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯• (å‰©ä½™å°è¯•æ¬¡æ•°: ${MAX_LOGIN_ATTEMPTS - loginAttempts})`;
                errorElement.style.display = 'block';
                generateCaptcha();
                
                // è®°å½•å®‰å…¨äº‹ä»¶
                logSecurityEvent('login_failed', username);
            }
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            const currentUser = localStorage.getItem('currentUser');
            logSecurityEvent('logout', currentUser);
            
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('currentUser');
            showLoginPage();
        }
        
        // è®°å½•å®‰å…¨äº‹ä»¶
        function logSecurityEvent(eventType, username) {
            const timestamp = new Date().toISOString();
            console.log(`Security Event: ${eventType} | User: ${username} | Time: ${timestamp}`);
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å°†å®‰å…¨äº‹ä»¶å‘é€åˆ°æœåŠ¡å™¨è®°å½•
        }
        
        // è·å–æ‰€æœ‰è®¢å•ï¼ˆåŒ…æ‹¬ä»£å–å¿«é€’å’Œè·‘è…¿ä»»åŠ¡ï¼‰
        async function getOrders() {
            try {
                // åŒæ—¶è·å–ä¸¤ç§è®¢å•
                const [deliveryResult, errandResult] = await Promise.all([
                    supabase
                        .from('delivery_orders')
                        .select('*')
                        .order('created_at', { ascending: false }),
                    supabase
                        .from('errand_orders')
                        .select('*')
                        .order('created_at', { ascending: false })
                ]);

                if (deliveryResult.error) throw deliveryResult.error;
                if (errandResult.error) throw errandResult.error;

                // åˆå¹¶è®¢å•å¹¶æ·»åŠ ç±»å‹æ ‡è¯†
                const deliveryOrders = (deliveryResult.data || []).map(order => ({
                    ...order,
                    order_type: 'delivery'
                }));
                
                const errandOrders = (errandResult.data || []).map(order => ({
                    ...order,
                    order_type: 'errand'
                }));

                // åˆå¹¶å¹¶æ’åº
                const allOrders = [...deliveryOrders, ...errandOrders]
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                return allOrders;
            } catch (error) {
                console.error('è·å–è®¢å•å¤±è´¥:', error);
                alert('è·å–è®¢å•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return [];
            }
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        async function updateOrder(orderId, orderType, updates) {
            try {
                const updateData = {
                    ...updates,
                    updated_at: new Date().toISOString()
                };
                
                // æ ¹æ®è®¢å•ç±»å‹é€‰æ‹©è¡¨
                const tableName = orderType === 'delivery' ? 'delivery_orders' : 'errand_orders';
                
                const { data, error } = await supabase
                    .from(tableName)
                    .update(updateData)
                    .eq('id', orderId)
                    .select();

                if (error) throw error;

                // è®°å½•æ“ä½œæ—¥å¿—
                const currentUser = localStorage.getItem('currentUser');
                logSecurityEvent('order_updated', currentUser);

                return data[0];
            } catch (error) {
                console.error('æ›´æ–°è®¢å•å¤±è´¥:', error);
                throw error;
            }
        }
        
        // åˆ é™¤è®¢å•
        async function deleteOrder(orderId, orderType) {
            try {
                // æ ¹æ®è®¢å•ç±»å‹é€‰æ‹©è¡¨
                const tableName = orderType === 'delivery' ? 'delivery_orders' : 'errand_orders';
                
                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', orderId);

                if (error) throw error;

                // è®°å½•æ“ä½œæ—¥å¿—
                const currentUser = localStorage.getItem('currentUser');
                logSecurityEvent('order_deleted', currentUser);

                return true;
            } catch (error) {
                console.error('åˆ é™¤è®¢å•å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ¸²æŸ“ç®¡ç†å‘˜è®¢å•
        async function renderAdminOrders() {
            const orders = await getOrders();
            const adminOrdersList = document.getElementById('admin-orders-list');
            adminOrdersList.innerHTML = '';
            
            if (orders.length === 0) {
                adminOrdersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>æš‚æ— è®¢å•</p>
                    </div>
                `;
                return;
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const takenOrders = orders.filter(order => order.status === 'taken' || order.status === 'processing').length;
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
            document.getElementById('taken-orders').textContent = takenOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
            
            orders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                
                // æ ¹æ®è®¢å•ç±»å‹è®¾ç½®ä¸åŒçš„è¾¹æ¡†é¢œè‰²
                if (order.order_type === 'errand') {
                    orderItem.classList.add('errand');
                }

                let statusClass = '';
                let statusText = '';
                
                switch(order.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = 'å¾…æ¥å•';
                        break;
                    case 'taken':
                        statusClass = 'status-taken';
                        statusText = 'å·²æ¥å•';
                        break;
                    case 'processing':
                        statusClass = 'status-processing';
                        statusText = 'é…é€ä¸­';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = 'å·²å®Œæˆ';
                        break;
                }
                
                // æ ¹æ®è®¢å•ç±»å‹æ˜¾ç¤ºä¸åŒçš„å†…å®¹
                const isDelivery = order.order_type === 'delivery';
                
                orderItem.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">
                            ${order.id.slice(-6).toUpperCase()}
                            <span class="order-type ${isDelivery ? '' : 'errand'}">
                                ${isDelivery ? '[å¿«é€’]' : '[è·‘è…¿]'}
                            </span>
                        </div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-details">
                        ${isDelivery ? `
                            <div class="order-detail"><strong>ä¸‹å•äºº:</strong> ${order.contact_name}</div>
                            <div class="order-detail"><strong>è”ç³»æ–¹å¼:</strong> ${order.contact_info} (${order.contact_type || order.contact_method})</div>
                            <div class="order-detail"><strong>å–ä»¶åœ°å€:</strong> ${order.pickup_address}</div>
                            <div class="order-detail"><strong>é€è¾¾åœ°å€:</strong> ${order.delivery_address}</div>
                            <div class="order-detail"><strong>å–ä»¶ç :</strong> ${order.pickup_code}</div>
                            <div class="order-detail"><strong>æœŸæœ›æ—¶é—´:</strong> ${new Date(order.delivery_time).toLocaleString()}</div>
                        ` : `
                            <div class="order-detail"><strong>ä»»åŠ¡æ ‡é¢˜:</strong> ${order.title}</div>
                            <div class="order-detail"><strong>ä»»åŠ¡æè¿°:</strong> ${order.description}</div>
                            <div class="order-detail"><strong>å–ç‰©åœ°ç‚¹:</strong> ${order.pickup_location}</div>
                            <div class="order-detail"><strong>é€è¾¾åœ°ç‚¹:</strong> ${order.delivery_location}</div>
                            <div class="order-detail"><strong>è”ç³»äºº:</strong> ${order.contact_name}</div>
                            <div class="order-detail"><strong>è”ç³»æ–¹å¼:</strong> ${order.contact_info} (${order.contact_type})</div>
                            <div class="order-detail"><strong>æˆªæ­¢æ—¶é—´:</strong> ${new Date(order.deadline).toLocaleString()}</div>
                        `}
                        <div class="order-detail"><strong>é…¬åŠ³:</strong> ${order.reward}å…ƒ</div>
                        <div class="order-detail"><strong>å¤‡æ³¨:</strong> ${order.notes || 'æ— '}</div>
                        <div class="order-detail"><strong>å‘å¸ƒæ—¶é—´:</strong> ${new Date(order.created_at).toLocaleString()}</div>
                    </div>
                    ${order.taken_by ? `<div class="order-detail"><strong>æ¥å•äºº:</strong> ${order.taker_name || order.taken_by} (${order.taker_contact})</div>` : ''}
                    <div class="order-actions">
                        ${order.status !== 'completed' ? `<button class="action-btn btn-complete" data-id="${order.id}" data-type="${order.order_type}">æ ‡è®°å®Œæˆ</button>` : ''}
                        <button class="action-btn btn-cancel" data-id="${order.id}" data-type="${order.order_type}">åˆ é™¤è®¢å•</button>
                    </div>
                `;
                
                adminOrdersList.appendChild(orderItem);
            });
            
            // æ·»åŠ ç®¡ç†å‘˜æ“ä½œæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.btn-complete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    const orderType = this.dataset.type;
                    completeOrder(orderId, orderType);
                });
            });
            
            document.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    const orderType = this.dataset.type;
                    deleteOrderFromUI(orderId, orderType);
                });
            });
        }
        
        // å®Œæˆè®¢å•
        async function completeOrder(orderId, orderType) {
            try {
                await updateOrder(orderId, orderType, { status: 'completed' });
                await renderAdminOrders();
            } catch (error) {
                alert('æ ‡è®°å®Œæˆå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                console.error(error);
            }
        }
        
        // åˆ é™¤è®¢å•
        async function deleteOrderFromUI(orderId, orderType) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—ï¼Ÿ')) {
                try {
                    await deleteOrder(orderId, orderType);
                    await renderAdminOrders();
                } catch (error) {
                    alert('åˆ é™¤è®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    console.error(error);
                }
            }
        }
        
        // æ¸…é™¤å·²å®Œæˆè®¢å•
        async function clearCompletedOrders() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆè®¢å•å—ï¼Ÿ')) {
                try {
                    // åŒæ—¶æ¸…é™¤ä¸¤ä¸ªè¡¨ä¸­çš„å·²å®Œæˆè®¢å•
                    const [deliveryResult, errandResult] = await Promise.all([
                        supabase
                            .from('delivery_orders')
                            .delete()
                            .eq('status', 'completed'),
                        supabase
                            .from('errand_orders')
                            .delete()
                            .eq('status', 'completed')
                    ]);

                    if (deliveryResult.error) throw deliveryResult.error;
                    if (errandResult.error) throw errandResult.error;

                    // è®°å½•æ“ä½œæ—¥å¿—
                    const currentUser = localStorage.getItem('currentUser');
                    logSecurityEvent('clear_completed_orders', currentUser);

                    await renderAdminOrders();
                } catch (error) {
                    alert('æ¸…é™¤å·²å®Œæˆè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    console.error(error);
                }
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ® - ä¿®å¤ç‰ˆæœ¬
async function clearAllUserData() {
    if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·è®¢å•æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
    }
    
    // äºŒæ¬¡ç¡®è®¤
    if (!confirm('ğŸš¨ æœ€åç¡®è®¤ï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰è®¢å•æ•°æ®ï¼ŒåŒ…æ‹¬å¿«é€’è®¢å•å’Œè·‘è…¿ä»»åŠ¡ï¼\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"ä¸­æ­¢æ“ä½œã€‚')) {
        return;
    }
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const clearBtn = document.getElementById('clear-all-data');
        const originalText = clearBtn.innerHTML;
        clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ¸…ç†ä¸­...';
        clearBtn.disabled = true;
        
        // åˆ é™¤æ‰€æœ‰è®¢å•æ•°æ® - ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„åˆ é™¤æ¡ä»¶
        const [deliveryResult, errandResult, chatResult] = await Promise.all([
            supabase
                .from('delivery_orders')
                .delete()
                .not('id', 'is', null), // ä¿®å¤ï¼šåˆ é™¤æ‰€æœ‰è®°å½•çš„æ­£ç¡®æ–¹å¼
            supabase
                .from('errand_orders')
                .delete()
                .not('id', 'is', null), // ä¿®å¤ï¼šåˆ é™¤æ‰€æœ‰è®°å½•çš„æ­£ç¡®æ–¹å¼
            supabase
                .from('chat_messages')
                .delete()
                .not('id', 'is', null)  // ä¿®å¤ï¼šåˆ é™¤æ‰€æœ‰è®°å½•çš„æ­£ç¡®æ–¹å¼
        ]);

        if (deliveryResult.error) throw deliveryResult.error;
        if (errandResult.error) throw errandResult.error;
        if (chatResult && chatResult.error) throw chatResult.error;

        // è®°å½•æ“ä½œæ—¥å¿—
        const currentUser = localStorage.getItem('currentUser');
        logSecurityEvent('clear_all_user_data', currentUser);

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        clearBtn.innerHTML = originalText;
        clearBtn.disabled = false;
        
        alert('âœ… æ‰€æœ‰ç”¨æˆ·æ•°æ®å·²æˆåŠŸæ¸…é™¤ï¼');
        await renderAdminOrders();
    } catch (error) {
        console.error('æ¸…é™¤ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        
        // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        if (error.message && error.message.includes('JWT')) {
            alert('æ¸…é™¤ç”¨æˆ·æ•°æ®å¤±è´¥ï¼šè®¤è¯é”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•ï¼');
        } else {
            alert('æ¸…é™¤ç”¨æˆ·æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ï¼é”™è¯¯ä¿¡æ¯ï¼š' + error.message);
        }
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const clearBtn = document.getElementById('clear-all-data');
        clearBtn.innerHTML = '<i class="fas fa-trash-alt"></i> æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®';
        clearBtn.disabled = false;
    }
}
        
       // æ¸…ç©ºèŠå¤©è®°å½• - ä¿®å¤ç‰ˆæœ¬
async function clearAllChatData() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('chat_messages')
            .delete()
            .not('id', 'is', null); // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„åˆ é™¤æ¡ä»¶

        if (error) throw error;

        // è®°å½•æ“ä½œæ—¥å¿—
        const currentUser = localStorage.getItem('currentUser');
        logSecurityEvent('clear_all_chat_data', currentUser);

        alert('æ‰€æœ‰èŠå¤©è®°å½•å·²æˆåŠŸæ¸…é™¤ï¼');
    } catch (error) {
        console.error('æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥:', error);
        
        // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        if (error.message && error.message.includes('JWT')) {
            alert('æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥ï¼šè®¤è¯é”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•ï¼');
        } else {
            alert('æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼é”™è¯¯ä¿¡æ¯ï¼š' + error.message);
        }
    }
}
        
        // å¯¼å‡ºæ•°æ®å¤‡ä»½
        async function exportData() {
            try {
                const orders = await getOrders();
                
                if (orders.length === 0) {
                    alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                    return;
                }
                
                // åˆ›å»ºCSVå†…å®¹
                let csvContent = "è®¢å•ID,ç±»å‹,çŠ¶æ€,ä¸‹å•äºº,è”ç³»æ–¹å¼,é…¬åŠ³(å…ƒ),åˆ›å»ºæ—¶é—´\n";
                
                orders.forEach(order => {
                    const isDelivery = order.order_type === 'delivery';
                    const type = isDelivery ? 'ä»£å–å¿«é€’' : 'è·‘è…¿ä»»åŠ¡';
                    
                    let status = '';
                    switch(order.status) {
                        case 'pending': status = 'å¾…æ¥å•'; break;
                        case 'taken': status = 'å·²æ¥å•'; break;
                        case 'processing': status = 'è¿›è¡Œä¸­'; break;
                        case 'completed': status = 'å·²å®Œæˆ'; break;
                        default: status = order.status;
                    }
                    
                    csvContent += `"${order.id}","${type}","${status}","${order.contact_name}","${order.contact_info}","${order.reward}","${new Date(order.created_at).toLocaleString()}"\n`;
                });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `æ ¡å›­æœåŠ¡å¹³å°æ•°æ®å¤‡ä»½_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                alert('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // æ¸²æŸ“ç®¡ç†å‘˜åˆ—è¡¨
        function renderAdminList() {
            const adminList = document.getElementById('admin-list');
            adminList.innerHTML = '';
            
            Object.keys(ADMIN_CREDENTIALS).forEach(username => {
                const admin = ADMIN_CREDENTIALS[username];
                const adminItem = document.createElement('div');
                adminItem.className = 'admin-item';
                
                adminItem.innerHTML = `
                    <div class="admin-info">
                        <div><strong>ç”¨æˆ·å:</strong> ${username}</div>
                        <div><strong>å§“å:</strong> ${admin.name}</div>
                        <div><strong>è§’è‰²:</strong> ${admin.role === 'super_admin' ? 'æ€»ç®¡ç†å‘˜' : 'æ™®é€šç®¡ç†å‘˜'}</div>
                    </div>
                    <div class="admin-actions">
                        <button class="action-btn btn-edit" data-username="${username}">ç¼–è¾‘</button>
                        ${username !== 'superadmin' && username !== 'admin' ? `<button class="action-btn btn-cancel" data-username="${username}">åˆ é™¤</button>` : ''}
                    </div>
                `;
                
                adminList.appendChild(adminItem);
            });
            
            // æ·»åŠ ç®¡ç†å‘˜æ“ä½œæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.admin-actions .btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.dataset.username;
                    editAdmin(username);
                });
            });
            
            document.querySelectorAll('.admin-actions .btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.dataset.username;
                    deleteAdmin(username);
                });
            });
        }
        
        // ç¼–è¾‘ç®¡ç†å‘˜
        function editAdmin(username) {
            const admin = ADMIN_CREDENTIALS[username];
            document.getElementById('new-username').value = username;
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('admin-role').value = admin.role;
            
            document.getElementById('admin-form').style.display = 'grid';
            document.getElementById('new-username').disabled = true;
        }
        
        // åˆ é™¤ç®¡ç†å‘˜
        function deleteAdmin(username) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ç®¡ç†å‘˜ ${username} å—ï¼Ÿ`)) {
                delete ADMIN_CREDENTIALS[username];
                saveAdminCredentials(ADMIN_CREDENTIALS);
                renderAdminList();
                
                // è®°å½•æ“ä½œæ—¥å¿—
                const currentUser = localStorage.getItem('currentUser');
                logSecurityEvent('admin_deleted', currentUser);
            }
        }
        
        // ä¿å­˜ç®¡ç†å‘˜
        function saveAdmin() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const role = document.getElementById('admin-role').value;
            
            if (!username || !password) {
                alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            if (ADMIN_CREDENTIALS[username] && !document.getElementById('new-username').disabled) {
                alert('ç”¨æˆ·åå·²å­˜åœ¨');
                return;
            }
            
            // ä¿å­˜ç®¡ç†å‘˜ä¿¡æ¯
            ADMIN_CREDENTIALS[username] = {
                password: password,
                role: role,
                name: `ç®¡ç†å‘˜${Object.keys(ADMIN_CREDENTIALS).length}`
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveAdminCredentials(ADMIN_CREDENTIALS);
            
            // è®°å½•æ“ä½œæ—¥å¿—
            const currentUser = localStorage.getItem('currentUser');
            logSecurityEvent('admin_updated', currentUser);
            
            renderAdminList();
            cancelAdmin();
        }
        
        // å–æ¶ˆç¼–è¾‘ç®¡ç†å‘˜
        function cancelAdmin() {
            document.getElementById('admin-form').style.display = 'none';
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('admin-role').value = 'admin';
            document.getElementById('new-username').disabled = false;
        }
        
        // é‡ç½®ç®¡ç†å‘˜è´¦æˆ·
        function resetAdminAccounts() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰ç®¡ç†å‘˜è´¦æˆ·ï¼Œåªä¿ç•™é»˜è®¤è´¦æˆ·ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            // äºŒæ¬¡ç¡®è®¤
            if (!confirm('ğŸš¨ æœ€åç¡®è®¤ï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰ç®¡ç†å‘˜è´¦æˆ·ï¼\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"ä¸­æ­¢æ“ä½œã€‚')) {
                return;
            }
            
            try {
                // é‡ç½®ç®¡ç†å‘˜è´¦æˆ·
                ADMIN_CREDENTIALS = resetAdminCredentials();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                document.getElementById('reset-success').style.display = 'block';
                document.getElementById('reset-warning').style.display = 'none';
                
                // é‡æ–°æ¸²æŸ“ç®¡ç†å‘˜åˆ—è¡¨
                renderAdminList();
                
                // è®°å½•æ“ä½œæ—¥å¿—
                const currentUser = localStorage.getItem('currentUser');
                logSecurityEvent('admin_reset', currentUser);
                
                // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                    document.getElementById('reset-success').style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error('é‡ç½®ç®¡ç†å‘˜è´¦æˆ·å¤±è´¥:', error);
                alert('é‡ç½®ç®¡ç†å‘˜è´¦æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // ç™»å½•æŒ‰é’®
            document.getElementById('login-btn').addEventListener('click', login);
            
            // å›è½¦é”®ç™»å½•
            document.getElementById('admin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // éªŒè¯ç åˆ·æ–°
            document.getElementById('captcha-display').addEventListener('click', generateCaptcha);
            
            // é€€å‡ºç™»å½•
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // åˆ·æ–°è®¢å•
            document.getElementById('refresh-orders').addEventListener('click', renderAdminOrders);
            
            // æ¸…é™¤å·²å®Œæˆè®¢å•
            document.getElementById('clear-completed').addEventListener('click', clearCompletedOrders);
            
            // æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®
            document.getElementById('clear-all-data').addEventListener('click', clearAllUserData);
            
            // æ¸…ç©ºèŠå¤©è®°å½•
            document.getElementById('clear-chat-data').addEventListener('click', clearAllChatData);
            
            // å¯¼å‡ºæ•°æ®
            document.getElementById('export-data').addEventListener('click', exportData);
            
            // é‡ç½®ç®¡ç†å‘˜è´¦æˆ·
            document.getElementById('reset-admin-btn').addEventListener('click', resetAdminAccounts);
            
            // ç®¡ç†å‘˜ç®¡ç†
            document.getElementById('add-admin-btn').addEventListener('click', function() {
                document.getElementById('admin-form').style.display = 'grid';
                document.getElementById('new-username').disabled = false;
                document.getElementById('reset-warning').style.display = 'none';
                document.getElementById('reset-success').style.display = 'none';
            });
            
            document.getElementById('save-admin').addEventListener('click', saveAdmin);
            document.getElementById('cancel-admin').addEventListener('click', cancelAdmin);
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            checkLoginStatus();
            initEventListeners();
        }
        
        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
