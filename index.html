<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园代取快递 - 管理平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4da6ff, #3399ff);
            color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4da6ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-btn {
            flex: 1;
            padding: 12px;
            background-color: #4da6ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .admin-btn:hover {
            background-color: #3d8cd9;
        }
        
        .order-list {
            margin-top: 15px;
        }
        
        .order-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4da6ff;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-weight: bold;
            color: #4da6ff;
        }
        
        .order-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-taken {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .order-detail {
            margin-bottom: 5px;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-complete {
            background-color: #28a745;
            color: white;
        }
        
        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .order-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>校园代取快递 - 管理平台</h1>
            <p class="subtitle">订单管理与统计</p>
        </header>
        
        <div class="card">
            <h2>订单统计</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-orders">0</div>
                    <div class="stat-label">总订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pending-orders">0</div>
                    <div class="stat-label">待处理</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="taken-orders">0</div>
                    <div class="stat-label">已接单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-orders">0</div>
                    <div class="stat-label">已完成</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <button class="admin-btn" id="refresh-orders">
                    <i class="fas fa-sync-alt"></i> 刷新订单
                </button>
                <button class="admin-btn" id="clear-completed">
                    <i class="fas fa-trash"></i> 清除已完成
                </button>
            </div>
            
            <div class="order-list" id="admin-orders-list">
                <!-- 所有订单将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // Supabase 配置（与用户平台相同）
        const SUPABASE_URL = 'https://mdkvoofsjmwxwsfoudbz.supabase.co'; // 替换为你的Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ka3Zvb2Zzam13eHdzZm91ZGJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODE2NTgsImV4cCI6MjA3NjQ1NzY1OH0.KXwS4CWYM5RIJ9RzQAVwAn9f1qvDBHykbil0CVykFP8'; // 替换为你的Supabase anon key
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 获取所有订单
        async function getOrders() {
            try {
                const { data, error } = await supabase
                    .from('delivery_orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('获取订单失败:', error);
                return [];
            }
        }
        
        // 更新订单状态
        async function updateOrder(orderId, updates) {
            try {
                const updateData = {
                    ...updates,
                    updated_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('delivery_orders')
                    .update(updateData)
                    .eq('id', orderId)
                    .select();
                
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('更新订单失败:', error);
                throw error;
            }
        }
        
        // 删除订单
        async function deleteOrder(orderId) {
            try {
                const { error } = await supabase
                    .from('delivery_orders')
                    .delete()
                    .eq('id', orderId);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('删除订单失败:', error);
                throw error;
            }
        }
        
        // 渲染管理员订单
        async function renderAdminOrders() {
            const orders = await getOrders();
            const adminOrdersList = document.getElementById('admin-orders-list');
            adminOrdersList.innerHTML = '';
            
            if (orders.length === 0) {
                adminOrdersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无订单</p>
                    </div>
                `;
                return;
            }
            
            // 更新统计信息
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const takenOrders = orders.filter(order => order.status === 'taken' || order.status === 'processing').length;
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
            document.getElementById('taken-orders').textContent = takenOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
            
            orders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                
                let statusClass = '';
                let statusText = '';
                
                switch(order.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = '待接单';
                        break;
                    case 'taken':
                        statusClass = 'status-taken';
                        statusText = '已接单';
                        break;
                    case 'processing':
                        statusClass = 'status-processing';
                        statusText = '配送中';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = '已完成';
                        break;
                }
                
                orderItem.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">${order.id.slice(-6).toUpperCase()}</div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-details">
                        <div class="order-detail"><strong>下单人:</strong> ${order.contact_name}</div>
                        <div class="order-detail"><strong>联系方式:</strong> ${order.contact_info} (${order.contact_method})</div>
                        <div class="order-detail"><strong>取件地址:</strong> ${order.pickup_address}</div>
                        <div class="order-detail"><strong>送达地址:</strong> ${order.delivery_address}</div>
                        <div class="order-detail"><strong>取件码:</strong> ${order.pickup_code}</div>
                        <div class="order-detail"><strong>货物重量:</strong> ${order.package_weight || '未指定'}</div>
                        <div class="order-detail"><strong>物品类型:</strong> ${order.package_type || '未选择'}</div>
                        <div class="order-detail"><strong>期望时间:</strong> ${new Date(order.delivery_time).toLocaleString()}</div>
                        <div class="order-detail"><strong>酬劳:</strong> ${order.reward}元</div>
                        <div class="order-detail"><strong>备注:</strong> ${order.notes || '无'}</div>
                        <div class="order-detail"><strong>发布时间:</strong> ${new Date(order.created_at).toLocaleString()}</div>
                    </div>
                    ${order.taken_by ? `<div class="order-detail"><strong>接单人:</strong> ${order.taker_name} (${order.taker_contact})</div>` : ''}
                    <div class="order-actions">
                        ${order.status !== 'completed' ? `<button class="action-btn btn-complete" data-id="${order.id}">标记完成</button>` : ''}
                        <button class="action-btn btn-cancel" data-id="${order.id}">删除订单</button>
                    </div>
                `;
                
                adminOrdersList.appendChild(orderItem);
            });
            
            // 添加管理员操作按钮事件
            document.querySelectorAll('.btn-complete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    completeOrder(orderId);
                });
            });
            
            document.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    deleteOrderFromUI(orderId);
                });
            });
        }
        
        // 完成订单
        async function completeOrder(orderId) {
            try {
                await updateOrder(orderId, { status: 'completed' });
                await renderAdminOrders();
            } catch (error) {
                alert('标记完成失败，请重试！');
                console.error(error);
            }
        }
        
        // 删除订单
        async function deleteOrderFromUI(orderId) {
            if (confirm('确定要删除这个订单吗？')) {
                try {
                    await deleteOrder(orderId);
                    await renderAdminOrders();
                } catch (error) {
                    alert('删除订单失败，请重试！');
                    console.error(error);
                }
            }
        }
        
        // 清除已完成订单
        async function clearCompletedOrders() {
            if (confirm('确定要清除所有已完成订单吗？')) {
                try {
                    const { error } = await supabase
                        .from('delivery_orders')
                        .delete()
                        .eq('status', 'completed');
                    
                    if (error) throw error;
                    await renderAdminOrders();
                } catch (error) {
                    alert('清除已完成订单失败，请重试！');
                    console.error(error);
                }
            }
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 刷新订单
            document.getElementById('refresh-orders').addEventListener('click', renderAdminOrders);
            
            // 清除已完成订单
            document.getElementById('clear-completed').addEventListener('click', clearCompletedOrders);
        }
        
        // 初始化应用
        async function initApp() {
            try {
                // 检查是否有订单数据
                const orders = await getOrders();
                
                if (orders.length === 0) {
                    document.getElementById('admin-orders-list').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>暂无订单数据，请先在用户平台发布订单</p>
                            <p style="margin-top: 10px;">
                                <a href="https://B1668711.github.io/campus-delivery-user" 
                                   style="color: #4da6ff; text-decoration: underline;">
                                    前往用户平台
                                </a>
                            </p>
                        </div>
                    `;
                } else {
                    initEventListeners();
                    await renderAdminOrders();
                }
            } catch (error) {
                console.error('初始化应用失败:', error);
                document.getElementById('admin-orders-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>连接数据库失败，请检查网络连接</p>
                    </div>
                `;
            }
        }
        
        // 启动应用
        initApp();
    </script>
</body>
</html>