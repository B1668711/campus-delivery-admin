<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园代取快递 - 管理平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* 登录页面样式 */
        .login-container {
            background-color: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4da6ff;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: #f9f9f9;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4da6ff;
            background-color: white;
        }
        
        .captcha-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .captcha-input {
            flex: 1;
        }
        
        .captcha-display {
            background: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            letter-spacing: 2px;
            user-select: none;
            cursor: pointer;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }
        
        .captcha-display span {
            position: relative;
            z-index: 2;
        }
        
        .captcha-display::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
            z-index: 1;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4da6ff, #3399ff);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, #3d8cd9, #2a7acc);
        }
        
        .login-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #ff4757;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* 管理界面样式 */
        .admin-content {
            display: none;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4da6ff, #3399ff);
            color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .card h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4da6ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-btn {
            flex: 1;
            padding: 12px;
            background-color: #4da6ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .admin-btn:hover {
            background-color: #3d8cd9;
        }
        
        .admin-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .order-list {
            margin-top: 15px;
        }
        
        .order-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4da6ff;
        }
        
        .order-item.errand {
            border-left-color: #07c160;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-weight: bold;
            color: #4da6ff;
        }
        
        .order-type {
            display: inline-block;
            padding: 2px 8px;
            background-color: #f0f8ff;
            color: #4da6ff;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .order-type.errand {
            background-color: #e8f7ef;
            color: #07c160;
        }
        
        .order-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-taken {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .order-detail {
            margin-bottom: 5px;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-complete {
            background-color: #28a745;
            color: white;
        }
        
        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .user-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: white;
            padding: 8px 16px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .admin-management {
            display: none;
        }
        
        .admin-list {
            margin-top: 15px;
        }
        
        .admin-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-info {
            flex: 1;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
        }
        
        .admin-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .form-actions {
            grid-column: span 2;
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .order-details {
                grid-template-columns: 1fr;
            }
            
            .admin-form {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div class="login-container" id="login-page">
        <div class="login-header">
            <h1>校园代取快递</h1>
            <p>管理平台登录</p>
        </div>
        
        <div class="form-group">
            <label for="admin-username">用户名</label>
            <input type="text" id="admin-username" placeholder="请输入用户名">
        </div>
        
        <div class="form-group">
            <label for="admin-password">密码</label>
            <input type="password" id="admin-password" placeholder="请输入密码">
        </div>
        
        <div class="form-group">
            <label for="captcha">验证码</label>
            <div class="captcha-container">
                <input type="text" id="captcha" class="captcha-input" placeholder="请输入验证码" maxlength="4">
                <div id="captcha-display" class="captcha-display">
                    <span id="captcha-text"></span>
                </div>
            </div>
        </div>
        
        <button class="login-btn" id="login-btn">登录</button>
        <div class="error-message" id="login-error">用户名或密码错误，请重试</div>
    </div>
    
    <!-- 管理界面 -->
    <div class="container admin-content" id="admin-content">
        <div class="user-info" id="user-info">
            <i class="fas fa-user"></i> <span id="current-user">管理员</span>
        </div>
        <button class="logout-btn" id="logout-btn">退出登录</button>
        
        <header>
            <h1>校园服务平台 - 管理平台</h1>
            <p class="subtitle">订单管理与统计</p>
        </header>
        
        <!-- 普通管理员和总管理员都能看到的部分 -->
        <div class="card">
            <h2>订单统计</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-orders">0</div>
                    <div class="stat-label">总订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pending-orders">0</div>
                    <div class="stat-label">待处理</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="taken-orders">0</div>
                    <div class="stat-label">已接单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-orders">0</div>
                    <div class="stat-label">已完成</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <button class="admin-btn" id="refresh-orders">
                    <i class="fas fa-sync-alt"></i> 刷新订单
                </button>
                <button class="admin-btn" id="clear-completed">
                    <i class="fas fa-trash"></i> 清除已完成
                </button>
            </div>
            
            <div class="order-list" id="admin-orders-list">
                <!-- 所有订单将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 只有总管理员能看到的部分 -->
        <div class="card admin-management" id="admin-management">
            <h2>管理员管理</h2>
            
            <div class="admin-controls">
                <button class="admin-btn" id="add-admin-btn">
                    <i class="fas fa-plus"></i> 添加管理员
                </button>
            </div>
            
            <div class="admin-form" id="admin-form" style="display: none;">
                <div class="form-group">
                    <label for="new-username">用户名</label>
                    <input type="text" id="new-username" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="new-password">密码</label>
                    <input type="password" id="new-password" placeholder="请输入密码">
                </div>
                <div class="form-group">
                    <label for="confirm-password">确认密码</label>
                    <input type="password" id="confirm-password" placeholder="请再次输入密码">
                </div>
                <div class="form-group">
                    <label for="admin-role">角色</label>
                    <select id="admin-role">
                        <option value="admin">普通管理员</option>
                        <option value="super_admin">总管理员</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="admin-btn" id="save-admin">保存</button>
                    <button class="admin-btn" id="cancel-admin" style="background-color: #6c757d;">取消</button>
                </div>
            </div>
            
            <div class="admin-list" id="admin-list">
                <!-- 管理员列表将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // Supabase 配置
        const SUPABASE_URL = 'https://mdkvoofsjmwxwsfoudbz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ka3Zvb2Zzam13eHdzZm91ZGJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODE2NTgsImV4cCI6MjA3NjQ1NzY1OH0.KXwS4CWYM5RIJ9RzQAVwAn9f1qvDBHykbil0CVykFP8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 管理员账号信息
        const ADMIN_CREDENTIALS = {
            // 总管理员
            'superadmin': {
                password: 'superadmin123',
                role: 'super_admin',
                name: '总管理员'
            },
            // 普通管理员
            'admin1': {
                password: 'admin123',
                role: 'admin',
                name: '管理员1'
            },
            'admin2': {
                password: 'admin123',
                role: 'admin',
                name: '管理员2'
            },
            'admin3': {
                password: 'admin123',
                role: 'admin',
                name: '管理员3'
            },
            'admin4': {
                password: 'admin123',
                role: 'admin',
                name: '管理员4'
            },
            'admin5': {
                password: 'admin123',
                role: 'admin',
                name: '管理员5'
            }
        };
        
        // 安全相关变量
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 5;
        let captchaCode = '';
        
        // 生成4位随机验证码（中英文混合）
        function generateCaptcha() {
            // 中文字符集
            const chineseChars = '的一是在不了有和人这中大为上个国我以要他时来用们生到作地于出就分对成会可主发年动同工也能下过子说产种面而方后多定行学法所民得经十三之进着等部度家电力里如水化高自二理起小物现实加量都两体制机当使点从业本去把性好应开它合还因由其些然前外天政四日那社义事平形相全表间样与关各重新线内数正心反你明看原又么后利';
            
            // 英文字符集
            const englishChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            
            // 混合字符集
            const mixedChars = chineseChars + englishChars;
            
            // 生成4位验证码
            let captcha = '';
            for (let i = 0; i < 4; i++) {
                const randomIndex = Math.floor(Math.random() * mixedChars.length);
                captcha += mixedChars[randomIndex];
            }
            
            captchaCode = captcha;
            
            // 显示验证码，并添加变形效果
            const captchaText = document.getElementById('captcha-text');
            captchaText.innerHTML = '';
            
            for (let i = 0; i < captcha.length; i++) {
                const charSpan = document.createElement('span');
                charSpan.textContent = captcha[i];
                
                // 随机旋转角度
                const rotation = Math.floor(Math.random() * 30) - 15;
                charSpan.style.transform = `rotate(${rotation}deg)`;
                
                // 随机字体大小
                const fontSize = 18 + Math.floor(Math.random() * 8);
                charSpan.style.fontSize = `${fontSize}px`;
                
                // 随机颜色
                const colors = ['#4da6ff', '#3399ff', '#ff4757', '#2ed573', '#ffa502'];
                const colorIndex = Math.floor(Math.random() * colors.length);
                charSpan.style.color = colors[colorIndex];
                
                captchaText.appendChild(charSpan);
            }
            
            // 添加背景干扰线
            const captchaDisplay = document.getElementById('captcha-display');
            captchaDisplay.style.backgroundImage = generateNoiseLines();
        }
        
        // 生成背景干扰线 - 修复版本
        function generateNoiseLines() {
            const lineCount = 5;
            let lines = [];
            
            for (let i = 0; i < lineCount; i++) {
                const startX = Math.random() * 100;
                const startY = Math.random() * 100;
                const endX = Math.random() * 100;
                const endY = Math.random() * 100;
                const color = `rgba(${Math.floor(Math.random() * 100)}, ${Math.floor(Math.random() * 100)}, ${Math.floor(Math.random() * 100)}, 0.3)`;
                
                lines.push(`linear-gradient(${Math.random() * 360}deg, transparent ${startX}%, ${color} ${startY}%, transparent ${endX}%)`);
            }
            
            return lines.join(', ');
        }
        
        // 检查登录状态
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const currentUser = localStorage.getItem('currentUser');
            
            if (isLoggedIn && currentUser) {
                showAdminContent(currentUser);
            } else {
                showLoginPage();
            }
        }
        
        // 显示登录页面
        function showLoginPage() {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
            generateCaptcha();
            
            // 重置表单
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('captcha').value = '';
        }
        
        // 显示管理内容
        function showAdminContent(username) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            
            const userInfo = ADMIN_CREDENTIALS[username];
            document.getElementById('current-user').textContent = userInfo.name;
            
            // 如果是总管理员，显示管理员管理功能
            if (userInfo.role === 'super_admin') {
                document.getElementById('admin-management').style.display = 'block';
                renderAdminList();
            } else {
                document.getElementById('admin-management').style.display = 'none';
            }
            
            renderAdminOrders();
        }
        
        // 登录验证
        function login() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const captcha = document.getElementById('captcha').value;
            const errorElement = document.getElementById('login-error');
            
            // 检查验证码
            if (captcha !== captchaCode) {
                errorElement.textContent = '验证码错误，请重新输入';
                errorElement.style.display = 'block';
                generateCaptcha();
                return;
            }
            
            // 检查登录尝试次数
            if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                errorElement.textContent = '登录尝试次数过多，请稍后再试';
                errorElement.style.display = 'block';
                document.getElementById('login-btn').disabled = true;
                setTimeout(() => {
                    document.getElementById('login-btn').disabled = false;
                    loginAttempts = 0;
                }, 30000); // 30秒后重置
                return;
            }
            
            // 验证用户名和密码
            if (ADMIN_CREDENTIALS[username] && ADMIN_CREDENTIALS[username].password === password) {
                // 登录成功
                localStorage.setItem('adminLoggedIn', 'true');
                localStorage.setItem('currentUser', username);
                loginAttempts = 0;
                showAdminContent(username);
                
                // 记录登录日志
                logSecurityEvent('login_success', username);
            } else {
                // 登录失败
                loginAttempts++;
                errorElement.textContent = `用户名或密码错误，请重试 (剩余尝试次数: ${MAX_LOGIN_ATTEMPTS - loginAttempts})`;
                errorElement.style.display = 'block';
                generateCaptcha();
                
                // 记录安全事件
                logSecurityEvent('login_failed', username);
            }
        }
        
        // 退出登录
        function logout() {
            const currentUser = localStorage.getItem('currentUser');
            logSecurityEvent('logout', currentUser);
            
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('currentUser');
            showLoginPage();
        }
        
        // 记录安全事件
        function logSecurityEvent(eventType, username) {
            const timestamp = new Date().toISOString();
            console.log(`Security Event: ${eventType} | User: ${username} | Time: ${timestamp}`);
            
            // 在实际应用中，这里应该将安全事件发送到服务器记录
        }
        
        // 获取所有订单（包括代取快递和跑腿任务）
        async function getOrders() {
            try {
                // 同时获取两种订单
                const [deliveryResult, errandResult] = await Promise.all([
                    supabase
                        .from('delivery_orders')
                        .select('*')
                        .order('created_at', { ascending: false }),
                    supabase
                        .from('errand_orders')
                        .select('*')
                        .order('created_at', { ascending: false })
                ]);

                if (deliveryResult.error) throw deliveryResult.error;
                if (errandResult.error) throw errandResult.error;

                // 合并订单并添加类型标识
                const deliveryOrders = (deliveryResult.data || []).map(order => ({
                    ...order,
                    order_type: 'delivery'
                }));
                
                const errandOrders = (errandResult.data || []).map(order => ({
                    ...order,
                    order_type: 'errand'
                }));

                // 合并并排序
                const allOrders = [...deliveryOrders, ...errandOrders]
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                return allOrders;
            } catch (error) {
                console.error('获取订单失败:', error);
                alert('获取订单失败，请检查网络连接');
                return [];
            }
        }
        
        // 更新订单状态
        async function updateOrder(orderId, orderType, updates) {
            try {
                const updateData = {
                    ...updates,
                    updated_at: new Date().toISOString()
                };
                
                // 根据订单类型选择表
                const tableName = orderType === 'delivery' ? 'delivery_orders' : 'errand_orders';
                
                const { data, error } = await supabase
                    .from(tableName)
                    .update(updateData)
                    .eq('id', orderId)
                    .select();

                if (error) throw error;

                // 记录操作日志
                const currentUser = localStorage.getItem('currentUser');
                logSecurityEvent('order_updated', currentUser);

                return data[0];
            } catch (error) {
                console.error('更新订单失败:', error);
                throw error;
            }
        }
        
        // 删除订单
        async function deleteOrder(orderId, orderType) {
            try {
                // 根据订单类型选择表
                const tableName = orderType === 'delivery' ? 'delivery_orders' : 'errand_orders';
                
                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', orderId);

                if (error) throw error;

                // 记录操作日志
                const currentUser = localStorage.getItem('currentUser');
                logSecurityEvent('order_deleted', currentUser);

                return true;
            } catch (error) {
                console.error('删除订单失败:', error);
                throw error;
            }
        }
        
        // 渲染管理员订单
        async function renderAdminOrders() {
            const orders = await getOrders();
            const adminOrdersList = document.getElementById('admin-orders-list');
            adminOrdersList.innerHTML = '';
            
            if (orders.length === 0) {
                adminOrdersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无订单</p>
                    </div>
                `;
                return;
            }
            
            // 更新统计信息
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const takenOrders = orders.filter(order => order.status === 'taken' || order.status === 'processing').length;
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
            document.getElementById('taken-orders').textContent = takenOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
            
            orders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                
                // 根据订单类型设置不同的边框颜色
                if (order.order_type === 'errand') {
                    orderItem.classList.add('errand');
                }

                let statusClass = '';
                let statusText = '';
                
                switch(order.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = '待接单';
                        break;
                    case 'taken':
                        statusClass = 'status-taken';
                        statusText = '已接单';
                        break;
                    case 'processing':
                        statusClass = 'status-processing';
                        statusText = '配送中';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = '已完成';
                        break;
                }
                
                // 根据订单类型显示不同的内容
                const isDelivery = order.order_type === 'delivery';
                
                orderItem.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">
                            ${order.id.slice(-6).toUpperCase()}
                            <span class="order-type ${isDelivery ? '' : 'errand'}">
                                ${isDelivery ? '[快递]' : '[跑腿]'}
                            </span>
                        </div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-details">
                        ${isDelivery ? `
                            <div class="order-detail"><strong>下单人:</strong> ${order.contact_name}</div>
                            <div class="order-detail"><strong>联系方式:</strong> ${order.contact_info} (${order.contact_type || order.contact_method})</div>
                            <div class="order-detail"><strong>取件地址:</strong> ${order.pickup_address}</div>
                            <div class="order-detail"><strong>送达地址:</strong> ${order.delivery_address}</div>
                            <div class="order-detail"><strong>取件码:</strong> ${order.pickup_code}</div>
                            <div class="order-detail"><strong>期望时间:</strong> ${new Date(order.delivery_time).toLocaleString()}</div>
                        ` : `
                            <div class="order-detail"><strong>任务标题:</strong> ${order.title}</div>
                            <div class="order-detail"><strong>任务描述:</strong> ${order.description}</div>
                            <div class="order-detail"><strong>取物地点:</strong> ${order.pickup_location}</div>
                            <div class="order-detail"><strong>送达地点:</strong> ${order.delivery_location}</div>
                            <div class="order-detail"><strong>联系人:</strong> ${order.contact_name}</div>
                            <div class="order-detail"><strong>联系方式:</strong> ${order.contact_info} (${order.contact_type})</div>
                            <div class="order-detail"><strong>截止时间:</strong> ${new Date(order.deadline).toLocaleString()}</div>
                        `}
                        <div class="order-detail"><strong>酬劳:</strong> ${order.reward}元</div>
                        <div class="order-detail"><strong>备注:</strong> ${order.notes || '无'}</div>
                        <div class="order-detail"><strong>发布时间:</strong> ${new Date(order.created_at).toLocaleString()}</div>
                    </div>
                    ${order.taken_by ? `<div class="order-detail"><strong>接单人:</strong> ${order.taker_name || order.taken_by} (${order.taker_contact})</div>` : ''}
                    <div class="order-actions">
                        ${order.status !== 'completed' ? `<button class="action-btn btn-complete" data-id="${order.id}" data-type="${order.order_type}">标记完成</button>` : ''}
                        <button class="action-btn btn-cancel" data-id="${order.id}" data-type="${order.order_type}">删除订单</button>
                    </div>
                `;
                
                adminOrdersList.appendChild(orderItem);
            });
            
            // 添加管理员操作按钮事件
            document.querySelectorAll('.btn-complete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    const orderType = this.dataset.type;
                    completeOrder(orderId, orderType);
                });
            });
            
            document.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    const orderType = this.dataset.type;
                    deleteOrderFromUI(orderId, orderType);
                });
            });
        }
        
        // 完成订单
        async function completeOrder(orderId, orderType) {
            try {
                await updateOrder(orderId, orderType, { status: 'completed' });
                await renderAdminOrders();
            } catch (error) {
                alert('标记完成失败，请重试！');
                console.error(error);
            }
        }
        
        // 删除订单
        async function deleteOrderFromUI(orderId, orderType) {
            if (confirm('确定要删除这个订单吗？')) {
                try {
                    await deleteOrder(orderId, orderType);
                    await renderAdminOrders();
                } catch (error) {
                    alert('删除订单失败，请重试！');
                    console.error(error);
                }
            }
        }
        
        // 清除已完成订单
        async function clearCompletedOrders() {
            if (confirm('确定要清除所有已完成订单吗？')) {
                try {
                    // 同时清除两个表中的已完成订单
                    const [deliveryResult, errandResult] = await Promise.all([
                        supabase
                            .from('delivery_orders')
                            .delete()
                            .eq('status', 'completed'),
                        supabase
                            .from('errand_orders')
                            .delete()
                            .eq('status', 'completed')
                    ]);

                    if (deliveryResult.error) throw deliveryResult.error;
                    if (errandResult.error) throw errandResult.error;

                    // 记录操作日志
                    const currentUser = localStorage.getItem('currentUser');
                    logSecurityEvent('clear_completed_orders', currentUser);

                    await renderAdminOrders();
                } catch (error) {
                    alert('清除已完成订单失败，请重试！');
                    console.error(error);
                }
            }
        }
        
        // 渲染管理员列表
        function renderAdminList() {
            const adminList = document.getElementById('admin-list');
            adminList.innerHTML = '';
            
            Object.keys(ADMIN_CREDENTIALS).forEach(username => {
                const admin = ADMIN_CREDENTIALS[username];
                const adminItem = document.createElement('div');
                adminItem.className = 'admin-item';
                
                adminItem.innerHTML = `
                    <div class="admin-info">
                        <div><strong>用户名:</strong> ${username}</div>
                        <div><strong>姓名:</strong> ${admin.name}</div>
                        <div><strong>角色:</strong> ${admin.role === 'super_admin' ? '总管理员' : '普通管理员'}</div>
                    </div>
                    <div class="admin-actions">
                        <button class="action-btn btn-edit" data-username="${username}">编辑</button>
                        ${username !== 'superadmin' ? `<button class="action-btn btn-cancel" data-username="${username}">删除</button>` : ''}
                    </div>
                `;
                
                adminList.appendChild(adminItem);
            });
            
            // 添加管理员操作按钮事件
            document.querySelectorAll('.admin-actions .btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.dataset.username;
                    editAdmin(username);
                });
            });
            
            document.querySelectorAll('.admin-actions .btn-cancel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.dataset.username;
                    deleteAdmin(username);
                });
            });
        }
        
        // 编辑管理员
        function editAdmin(username) {
            const admin = ADMIN_CREDENTIALS[username];
            document.getElementById('new-username').value = username;
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('admin-role').value = admin.role;
            
            document.getElementById('admin-form').style.display = 'grid';
            document.getElementById('new-username').disabled = true;
        }
        
        // 删除管理员
        function deleteAdmin(username) {
            if (confirm(`确定要删除管理员 ${username} 吗？`)) {
                delete ADMIN_CREDENTIALS[username];
                renderAdminList();
                
                // 记录操作日志
                const currentUser = localStorage.getItem('currentUser');
                logSecurityEvent('admin_deleted', currentUser);
            }
        }
        
        // 保存管理员
        function saveAdmin() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const role = document.getElementById('admin-role').value;
            
            if (!username || !password) {
                alert('用户名和密码不能为空');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('两次输入的密码不一致');
                return;
            }
            
            if (ADMIN_CREDENTIALS[username] && !document.getElementById('new-username').disabled) {
                alert('用户名已存在');
                return;
            }
            
            // 保存管理员信息
            ADMIN_CREDENTIALS[username] = {
                password: password,
                role: role,
                name: `管理员${Object.keys(ADMIN_CREDENTIALS).length}`
            };
            
            // 记录操作日志
            const currentUser = localStorage.getItem('currentUser');
            logSecurityEvent('admin_updated', currentUser);
            
            renderAdminList();
            cancelAdmin();
        }
        
        // 取消编辑管理员
        function cancelAdmin() {
            document.getElementById('admin-form').style.display = 'none';
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('admin-role').value = 'admin';
            document.getElementById('new-username').disabled = false;
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 登录按钮
            document.getElementById('login-btn').addEventListener('click', login);
            
            // 回车键登录
            document.getElementById('admin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // 验证码刷新
            document.getElementById('captcha-display').addEventListener('click', generateCaptcha);
            
            // 退出登录
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // 刷新订单
            document.getElementById('refresh-orders').addEventListener('click', renderAdminOrders);
            
            // 清除已完成订单
            document.getElementById('clear-completed').addEventListener('click', clearCompletedOrders);
            
            // 管理员管理
            document.getElementById('add-admin-btn').addEventListener('click', function() {
                document.getElementById('admin-form').style.display = 'grid';
                document.getElementById('new-username').disabled = false;
            });
            
            document.getElementById('save-admin').addEventListener('click', saveAdmin);
            document.getElementById('cancel-admin').addEventListener('click', cancelAdmin);
        }
        
        // 初始化应用
        function initApp() {
            checkLoginStatus();
            initEventListeners();
        }
        
        // 启动应用
        initApp();
    </script>
</body>
</html>
